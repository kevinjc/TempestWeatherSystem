import socket
import select
import time
import struct
import pprint
import json
import datetime
import redis

rds = redis.Redis(host='localhost', port=6379, db=0)

# create broadcast listener socket
def create_broadcast_listener_socket(broadcast_ip, broadcast_port):

    b_sock = socket.socket(socket.AF_INET, socket.SOCK_DGRAM, socket.IPPROTO_UDP)
    b_sock.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1)

    b_sock.bind(('', broadcast_port))

    mreq = struct.pack("4sl", socket.inet_aton(broadcast_ip), socket.INADDR_ANY)
    b_sock.setsockopt(socket.IPPROTO_IP, socket.IP_ADD_MEMBERSHIP, mreq)

    return b_sock

event_time = ""
temp = ""
batt = ""
lux = ""
ltndist = ""
ltncnt = ""
precipmm = ""
preciptp = ""
humid = ""
rad = ""
pressure = ""
uv = ""
windavg = ""
windgust = ""
windlull = ""
windspd = ""
winddir = ""

wind_count=0


# ip/port to listen to
BROADCAST_IP = '239.255.255.250'
BROADCAST_PORT = 50222

# create the listener socket
sock_list = [create_broadcast_listener_socket(BROADCAST_IP, BROADCAST_PORT)]

data_type = ""

#while True:
while data_type != 'obs_st':
    # small sleep otherwise this will loop too fast between messages and eat a lot of CPU
    time.sleep(0.01)

    # wait until there is a message to read
    readable, writable, exceptional = select.select(sock_list, [], sock_list, 0)

    # for each socket with a message
    for s in readable:
        data, addr = s.recvfrom(4096)

        # the obs_st data has double squ brackets`
        data=data.replace(b'[[', b'[')
        data=data.replace(b']]', b']')
        

        # convert data to json
        data_json = json.loads(data)
        print ( "Data type observed: ", data_json['type']  )
        #print("RAW DATA: ", data)

        if data_json['type'] == 'obs_st':
            data_type = "obs_st"
            event_time = data_json['obs'][0][0]
            windlull = data_json['obs'][0][1]
            windavg = data_json['obs'][0][2]
            windgust = data_json['obs'][0][3]
            winddir = data_json['obs'][0][4]
            windint = data_json['obs'][0][5]
            pressure = data_json['obs'][0][6]
            temp = data_json['obs'][0][7]
            humid = data_json['obs'][0][8]
            lux = data_json['obs'][0][9]
            uv = data_json['obs'][0][10]
            rad = data_json['obs'][0][11]
            precipmm = data_json['obs'][0][12]
            preciptp = data_json['obs'][0][13]
            ltndist = data_json['obs'][0][14]
            ltncnt = data_json['obs'][0][15]
            batt = data_json['obs'][0][16]
            interval = data_json['obs'][0][17]
            fixed_values =  ("[",event_time,windlull,
                    windavg,windgust,winddir,windint,
                    pressure,temp,humid,lux,uv,rad,precipmm,
                    preciptp,ltndist,ltncnt,batt,interval,"]" )
            rds.set('obs_st', str(fixed_values))
            print ("  at ", event_time, " the weather readings are, temp: ", temp )
            print ( "  humidity: ", humid )
            print ( "  the observation: ", data_json['obs'] )


        elif data_json['type'] == 'rapid_wind':
            data_type = "ob"
            #print ( "the observation: ", data_json['ob'] )
            rds.set('rapid_wind', str(data_json['ob']))
            event_time=data_json['ob'][0]
            windspd =  data_json['ob'][1]
            winddir =  data_json['ob'][2] 
            print ("  at time ", event_time, "we received wind speed ",windspd," from direction ", winddir)

        elif data_json['type'] == 'evt_strike':
            print ( "the observation: ", data_json['evt_strike'] )
            rds.set('evt_strike', str(data_json['evt_strike']))

        elif data_json['type'] == 'evt_precip':
            print ( "the observation: ", data_json['evt_precip'] )
            rds.set('evt_precip', str(data_json['evt_precip']))

        elif data_json['type'] ==  'hub_status':
            #print ("the observation: ", data_json['uptime'])
            rds.set('hub_status', str(data_json))

        elif data_json['type'] ==  'device_status':
            #print ("the observation: ", data_json['uptime'])
            rds.set('device_status', str(data_json))

        else:
            print ( "the observation keys: ", data_json.keys() )
        #    print(data_json)


